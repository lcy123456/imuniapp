<template>
    <view>
        <web-view
            ref="webviewRef"
            @onPostMessage="handlePostMessage"
            :style="{width: systemInfo.windowWidth + 'px', height: systemInfo.windowHeight + 'px'}"
            :src="src"
        />
    </view>
</template>

<script>
import { mapGetters, mapActions } from "vuex";
const { store } = getApp().globalData;

export default {
    data () {
        return {
            time: '',
            updateKey: '',
            systemInfo: uni.getSystemInfoSync()
        }
    },
    computed: {
        ...mapGetters([
            "storeCallType",
            "storeIncomingCallCallTime"
        ]),
        src () {
            return `/hybrid/html/chat.html?type=${this.storeCallType}`;
        }
    },
    onLoad () {
        console.log('onLoad-onLoad');
    },
    onReady () {
        uni.preloadPage({url: "/pages/conversation/webrtc/index"});
        console.log('onReady-onReady');
    },
    onShow () {
        if (this.time !== this.storeIncomingCallCallTime) {
            this.$refs.webviewRef.evalJs(`uniEvent(${JSON.stringify({})})`);
        }
        this.time = this.storeIncomingCallCallTime;
        console.log('onShow');
    },
    onUnload () {
        console.log('onUnloadonUnload');
    },
    onHide () {
        console.log('onHideonHideonHide');
    },
    methods: {
        handlePostMessage (event) {
            console.log('handlePostMessage()===', event)
            const [data] = event.detail.data
            if(data.isSmall) {
                // 缩小
                store.commit('incomingCall/SET_IS_INCOMING_CALL_SMALL', true);
            }
            if(data.isDanger) {
                // 挂断
                // store.commit('incomingCall/onDangerCall');
            }
            if(data.isSuccess) {
                // 接听

            }
        }
    }
}
</script>

<style>

</style>