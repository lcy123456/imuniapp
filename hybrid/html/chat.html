<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="lib/uni-webview-js@0.0.1.js"></script>
    <script src="lib/vue@2.js"></script>
    <script src="lib/livekit-client.umd.min.js"></script>
    <script src="lib/dayjs/dayjs.min.js"></script>
    <script src="lib/dayjs/duration.js"></script>
    <script>dayjs.extend(window.dayjs_plugin_duration)</script>
    <!-- <script src="./chat.js"></script> -->
</head>

<style type="text/css">
    * {
        padding: 0;
        margin: 0;
    }

    body,
    html {
        overflow: hidden;
    }
    .chat-single-css .my .avatar-box {
        display: none;
    }
    .chat-single-css {}

    .chat-group-css {
        padding: 0 20px;
        box-sizing: border-box;
        width: 100%;
        min-height: 250px;
        max-height: 360px;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        position: fixed;
        top: 10vh;
    }

    .chat-group-css .video-box {
        width: calc(50% - 10px)!important;
        height: 170px!important;
        margin: 5px;
        position: relative;
        overflow: hidden;
    }
    .avatar-box {
        position: relative;
        width: 100%!important;
        height: 100%!important;
        background-color: #5496EB;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #FFFFFF;
        font-size: 24px;
    }

    .video-box .video, .video-box .audio {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover;
        border-radius: 10px;
        position: absolute;
        left: 0;
        top: 0;
    }
    .video-box .video {
        z-index: 99;
    }

    .video-box.my .video-box {
        position: fixed;
        z-index: 2;
    }

    .video-box.other .video-box {
        position: fixed;
        z-index: 3!important;
    }

    .video-box.other .video-box {
        position: fixed;
        top: 50px !important;
        right: 20px !important;
        width: 40% !important;
        height: 25% !important;
        overflow: hidden;
        z-index: 2;
    }

    .audio-box {
        position: fixed;
        z-index: -1 !important;
    }

    #back {
        z-index: 999999;
    }

    .z-index-minus-1 {
        z-index: -1 !important;
    }
    .z-index-100 {
        z-index: 100;
    }

    .text-inverse {
        color: #FFFFFF;
    }

    .fz-14 {
        font-size: 14px;
    }

    .fz-16 {
        font-size: 16px;
    }

    .fz-21 {
        font-size: 21px;
    }

    .mt-7 {
        margin-top: 7px;
    }

    .mt-10 {
        margin-top: 10px;
    }


    .incoming_call_main {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .page_main_back {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1;
    }

    .incoming_call_main .header_panel {
        position: relative;
        margin-top: 3vh;
        height: 22px;
        line-height: 22px;
        text-align: center;
        z-index: 3;
    }

    .incoming_call_main .right_icon {
        position: absolute;
        top: 0;
        left: 43px;
        width: 22px;
        height: 22px;
    }

    .avatar_panel {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        margin-top: 12vh;
        position: relative;
        z-index: 1;
    }

    .avatar {
        background-color: #5496EB;
        border-radius: 10px;
        width: 70px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #FFFFFF;
        font-size: 18px;
    }

    .tips_text {
        font-size: 18px;
        color: #FFFFFF;
        height: 24px;
        line-height: 24px;
        text-align: center;
        margin-top: 80px;
    }

    .btn_nav {
        position: fixed;
        width: 86%;
        bottom: 10vh;
        left: 0;
        right: 0;
        margin: 0 auto;
        z-index: 3;
    }

    .handle_panel {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .handle_cell {
        display: flex;
        align-items: center;
        flex-direction: column;
    }

    .handle_icon {
        width: 70px;
        height: 70px;
    }

    .answer_panel {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 33px;
    }

    .answer_panel button {
        border-radius: 100%;
        width: 70px;
        height: 70px;
        border: none;
    }

    .answer_panel .overturn_small {
        position: absolute;
        top: 0;
        bottom: 0;
        right: 7%;
        width: 30px;
        height: 23px;
        margin: auto 0;
    }

    .flex-center {
        justify-content: center !important;
    }

    .call_icon {
        width: 30px;
        height: 30px;
    }

    .danger_btn {
        background-color: #F45955;
    }

    .danger_btn .call_icon {
        transform: rotate(135deg);
        margin-top: 5px;
    }

    .success_btn {
        background-color: #58BE6B;
    }
</style>

<body>
    <div id="app">
        <div class="chat-single-css">
            <div id="other-box" class="video-box other" @click="changeBox('other')"></div>
            <div id="my-box" class="video-box my" @click="changeBox('my')"></div>
        </div>
        <div id="chat-group-css" class="chat-group-css">

        </div>

        <div class="incoming_call_main">
            <image id="pageMainBack" class="page_main_back" src="images/incoming_call_main_back.png"></image>
            <div class="header_panel">
                <image id="back" @click="back" class="right_icon" src="images/incoming_call_main_reduce.png"></image>
                <span class="fz-16 text-inverse" v-if="isCallIng">{{ timeText }}</span>
            </div>
            <div v-if="isAlone" class="avatar_panel">
                <image class="avatar" :src="faceURLHandle" v-if="callUserInfo.faceURL"></image>
                <div class="avatar" v-else>{{ nicknameHandle }}</div>
                <p class="fz-21 text-inverse mt-7">{{ nicknameHandle }}</p>
            </div>
            <div v-if="isAlone && !isCallIng" class="tips_text">等待对方接受邀请</div>
            <div class="btn_nav">
                <div class="handle_panel">
                    <div class="handle_cell" @click="toggleAudio">
                        <image class="handle_icon" :src="micImage"></image>
                        <p class="mt-10 fz-14 text-inverse">{{ micText }}</p>
                    </div>
                    <!-- <div class="handle_cell">
                            <image class="handle_icon" :src="speakImage"></image>
                            <p class="mt-10 fz-14 text-inverse">{{ speakText }}</p>
                        </div> -->
                    <div class="handle_cell" @click="toggleVideo">
                        <image class="handle_icon" :src="camImage"></image>
                        <p class="mt-10 fz-14 text-inverse">{{ camText }}</p>
                    </div>
                </div>
                <div :class="['answer_panel', !isAnswer || isCallIng ? 'flex-center' : '']">
                    <button class="danger_btn" @click="goOut">
                        <image src="images/incoming_call_icon.png" class="call_icon" />
                    </button>
                    <button v-if="isAnswer && isCallLoading" class="success_btn">
                        <image src="images/incoming_call_icon.png" class="call_icon" />
                    </button>
                    <image class="overturn_small" src="images/incoming_call_handle_overturn_2.png" v-if="isCallIng"
                        @click="toggleVideoInput">
                    </image>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const {
            // Participant,
            // RemoteParticipant,
            // RemoteTrackPublication,
            RemoteTrack,
            Room,
            RoomEvent,
        } = window.LivekitClient;
        const defaultBaseMap = {
            message: {
                sessionType: 1,
                type: ''
            }
        };
        const app = new Vue({
            el: '#app',
            data: {
                name: '好好',
                type: '',
                device: '',
                timeText: '00:00',
                callTime: '',
                trackList: [],
                isDomIn: false,
                isCallLoading: false, // 双方等待接通电话
                isCallIng: false, // 正在通话中
                isAnswer: false, // true拨打电话 false接听电话
                callUserInfo: {
                    faceURL: '',
                    nickname: '未知',
                },
                baseMap: JSON.parse(JSON.stringify(defaultBaseMap)),
                room: null,
                isShowCall: false,
                micImage: 'images/incoming_call_handle_mic_2.png',
                micText: '麦克风已关',
                camImage: 'images/incoming_call_handle_cam_2.png',
                camText: '摄像头已关',
                speakImage: 'images/incoming_call_handle_speak_2.png',
                speakText: '扬声器已关'
            },
            computed: {
                // 群聊
                isGroup() {
                    return this.baseMap.message.sessionType === 3
                },
                // 个人聊天
                isAlone() {
                    return this.baseMap.message.sessionType !== 3
                },
                faceURLHandle() {
                    const faceURL = this.callUserInfo?.faceURL
                    return `defaultAvatars/${faceURL}.png`
                },
                nicknameHandle () {
                    const nickname = this.callUserInfo?.nickname
                    return nickname ? nickname.slice(nickname.length > 1 ? -2 : -1) : '未知';
                },
            },
            mounted() {
                this.init();
            },
            methods: {
                checkDom() {
                    if (this.isGroup) {
                        const dom = this.getDom('chat-group-css');
                        console.log(dom, '==');
                        this.isDomIn = !!dom.children[0];
                    } else {
                        const otherDom = this.getDom('other-box');
                        const myDom = this.getDom('my-box');
                        this.isDomIn = !!(otherDom.children[0] || myDom.children[0]);
                    }
                },
                init(data) {
                    this.baseMap = data || JSON.parse(JSON.stringify(defaultBaseMap));
                    if (data) {
                        const {
                            isCallLoading,
                            isCallIng,
                            isAnswer,
                            callUserInfo,
                            message
                        } = data
                        this.isCallLoading = isCallLoading
                        this.isCallIng = isCallIng
                        this.isAnswer = isAnswer
                        this.callUserInfo = callUserInfo

                        if(this.isCallIng) this.timerFn();
                    }
                    this.disconnect();
                    this.openRoom();
                },
                getLocationKeyValue(key) {
                    const reg = new RegExp(`${key}=([^&]*)`);
                    const href = location.href;
                    return href.match(reg) && href.match(reg)[1] ? href.match(reg)[1] : '';
                },
                getDom(id) {
                    return document.getElementById(id);
                },
                setDomAttr(map) {
                    // const { width = `300px`, height = `300px`, id, dom } = map;
                    const { width = `100%`, height = `${document.documentElement.clientHeight}px`, id, dom } = map;
                    if (!dom) return;
                    dom.id = id;
                    dom.className = map.className;
                    dom.style.width = width;
                    dom.style.height = height;
                },
                updateData() {
                    this.openRoom();
                },
                async toggleAudio() {
                    if (!this.room) return;
                    const enabled = this.room?.localParticipant?.isMicrophoneEnabled;
                    await this.room?.localParticipant?.setMicrophoneEnabled(!enabled);
                    this.setInitAudioImg();
                },
                setInitAudioImg() {
                    const enabled = this.room?.localParticipant?.isMicrophoneEnabled;
                    this.micImage = !enabled ? 'images/incoming_call_handle_mic_2.png' : 'images/incoming_call_handle_mic_1.png';
                    this.micText = !enabled ? '麦克风已关' : '麦克风已开';
                },

                async toggleVideo() {
                    if (!this.room) return;
                    const enabled = this.room?.localParticipant.isCameraEnabled;
                    await this.room?.localParticipant.setCameraEnabled(!enabled);
                    this.setInitVideoImg();
                    let myDom = null;
                    if (this.isGroup) {
                        myDom = this.getDom('chat-group-css');
                    } else {
                        myDom = this.getDom('my-box');
                    }

                    if(this.isGroup) {
                        const myAvatarDom = this.getDom('myVideo-avatar')
                        if(!enabled) myAvatarDom.classList.remove('z-index-100')
                        else myAvatarDom.classList.add('z-index-100')
                    } else {
                        const backDom = this.getDom('pageMainBack')
                        if(!enabled) backDom.classList.add('z-index-minus-1')
                        else backDom.classList.remove('z-index-minus-1')
                    }


                    console.log(myDom)
                    console.log('enabled====', enabled)
                    !enabled &&  this.addSelf({ parentDom: myDom, type: '' });
                },
                setInitVideoImg() {
                    const enabled = this.room?.localParticipant.isCameraEnabled;
                    this.camImage = !enabled ? 'images/incoming_call_handle_cam_2.png' : 'images/incoming_call_handle_cam_1.png';
                    this.camText = !enabled ? '摄像头已关' : '摄像头已开';
                },

                async toggleVideoInput() {
                    const devices = await Room.getLocalDevices('videoinput');
                    if (this.device === '') {
                        this.device = devices[1] || devices[0];
                    } else {
                        const otherDevices = devices.filter(item => item.deviceId !== this.device.deviceId);
                        this.device = otherDevices[0] || this.device;
                    }
                    this.device && await this.room.switchActiveDevice('videoinput', this.device.deviceId);
                },
                async openRoom() {
                    const wsURL = `ws://192.168.2.20:7880`;
                    const token = localStorage.getItem('token') || `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDAzNzY2ODAsImlzcyI6IkFQSVZWQ3BETGtaTHZSViIsIm5iZiI6MTY5Nzc4NDY4MCwic3ViIjoicGFydGljaXBhbnRJZGVudGl0eTMiLCJ2aWRlbyI6eyJyb29tIjoiTVVTSyIsInJvb21Kb2luIjp0cnVlfX0.Ca0sYNhNTdOHkwNk1mJeDQq9XWhjC0ska1j-rX1y9QA`;
                    this.room = new Room();
                    this.trackList = [];
                    try {
                        await this.room.connect(wsURL, token);
                        console.log('connected to room----', this.room.name);
                        // await p.enableCameraAndMicrophone();
                        let myDom = null;
                        let otherDom = null;
                        if (this.isGroup) {
                            myDom = this.getDom('chat-group-css');
                            otherDom = this.getDom('chat-group-css');
                        } else {
                            myDom = this.getDom('my-box');
                            otherDom = this.getDom('other-box');
                        }
                        this.removeMember({ parentDom: otherDom });
                        this.addInitMember({ parentDom: otherDom });
                        this.addJoinMember({ parentDom: otherDom });
                        this.addSelf({ parentDom: myDom, type: 'init' });
                    } catch (err) {
                        console.log('fail -----connected to room----', err);
                    }
                },
                // 断线删除成员
                async removeMember({ parentDom }) {
                    this.room.on(RoomEvent.ParticipantDisconnected, (participant) => {
                        this.removeElment({
                            participant,
                            parentDom
                        });
                    });
                },
                // 加入新进成员
                async addJoinMember({ parentDom }) {
                    this.room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
                        this.addElement({
                            parentDom,
                            track,
                            participant,
                            publication
                        });
                    });
                },
                // 初始化已在成员
                async addInitMember({ parentDom }) {
                    console.log(this.room?.participants, 'this.room?.participantsthis.room?.participants');
                    this.room?.participants?.forEach(participant => {
                        participant?.tracks?.forEach(track => {
                            this.addElement({
                                participant,
                                publication: track,
                                track: track.track,
                                parentDom
                            });
                        });
                    });
                },
                // 添加自己
                async addSelf({ parentDom, type }) {
                    const myVideoDom = this.getDom('myVideo-video');
                    const myAudioDom = this.getDom('myVideo-audio');
                    if (myVideoDom && myAudioDom) return;
                    const p = this.room.localParticipant;
                    try {
                        await p.setCameraEnabled(type ? (this.baseMap?.message?.type === 'video') : true);
                        await p.setMicrophoneEnabled(true);
                        [RemoteTrack.Source.Camera, RemoteTrack.Source.Microphone].forEach(source => {
                            console.log(source, 'sourcesource');
                            const track = p.getTrack(source);
                            const myVideo = track?.track?.attach();
                            console.log(track, 'track?.track');
                            if (myVideo) {
                                const dom = this.getDom(`myVideo`);
                                const div = dom || document.createElement('div');
                                const avatar = this.getDom(`myVideo-avatar`);
                                this.setDomAttr({
                                    dom: div,
                                    id: 'myVideo',
                                    className: 'video-box'
                                });
                                this.setDomAttr({
                                    dom: myVideo,
                                    id: `myVideo-${source === 'camera' ? 'video' : 'audio'}`,
                                    className: source === 'camera' ? 'video' : 'audio'
                                });
                                if (!avatar) {
                                    let avatarDom = ''
                                    const hasFaceURL = false
                                    if(hasFaceURL) {
                                        avatarDom = document.createElement('img');
                                        avatarDom.src = `https://img.cdn.aliyun.dcloud.net.cn/guide/uniapp/uni-h5-hosting-qr.png`
                                    } else {
                                        avatarDom = document.createElement('div');
                                        avatarDom.innerHTML = `菠萝`
                                    }
                                    this.setDomAttr({
                                        dom: avatarDom,
                                        id: `myVideo-avatar`,
                                        className: `avatar-box`
                                    });
                                    div.appendChild(avatarDom);
                                }
                                if (!this.getDom(`myVideo-${source === 'camera' ? 'video' : 'audio'}`)) {
                                    div.appendChild(myVideo);
                                }
                                !dom && parentDom.appendChild(div);
                            }
                        });
                    } catch (err) {
                        console.log('video，麦克风拒绝');
                    }
                    this.checkDom();
                    setTimeout(() => {
                        this.setInitVideoImg();
                        this.setInitAudioImg();
                    }, 0);
                },
                addElement({ parentDom, track, participant, publication = {} }) {
                    const { identity } = participant;
                    const element = track.attach();
                    const type = `${identity}-box`;
                    // if (this.trackList.includes(type)) {
                    //     const dom = this.getDom(type);
                    //     parentDom.removeChild(dom);
                    // }
                    console.log(publication, 'publicationpublicationpublicationpublication');
                    const dom = this.getDom(`${identity}-box`);
                    const avatar = this.getDom(`${identity}-avatar`);
                    const div = dom || document.createElement('div');
                    this.setDomAttr({
                        dom: div,
                        id: `${identity}-box`,
                        className: `video-box`
                    });
                    this.setDomAttr({
                        dom: element,
                        id: '',
                        className: `${track.kind}`
                    });
                    if (!avatar) {
                        const avatarDom = document.createElement('div');
                        this.setDomAttr({
                            dom: avatarDom,
                            id: `${identity}-avatar`,
                            className: `avatar-box`
                        });
                        div.appendChild(avatarDom);
                    }
                    div.appendChild(element);
                    !dom && parentDom.appendChild(div);
                    this.trackList.push(type);
                    this.checkDom();
                },
                changeBox(type) {
                    console.log('换');
                    const otherDom = this.getDom('other-box');
                    const myBoxDom = this.getDom('my-box');
                    if (type === 'other' && otherDom.className === `video-box other`) {
                        otherDom.className = `video-box my`;
                        myBoxDom.className = `video-box other`;
                    }
                    if (type === 'my' && otherDom.className === `video-box my`) {
                        otherDom.className = `video-box other`;
                        myBoxDom.className = `video-box my`;
                    }
                },
                removeElment({ parentDom, participant }) {
                    const { identity } = participant;
                    const dom = this.getDom(`${identity}-box`);
                    parentDom.removeChild(dom);
                    this.checkDom();
                },
                back() {
                    uni.postMessage({
                        data: {
                            isSmall: true
                        }
                    });
                    uni.navigateBack();
                },
                disconnect() {
                    const otherDom = this.getDom('other-box');
                    const myBoxDom = this.getDom('my-box');
                    const groupDom = this.getDom('chat-group-css');
                    otherDom && (otherDom.innerHTML = '');
                    myBoxDom && (myBoxDom.innerHTML = '');
                    groupDom && (groupDom.innerHTML = '');
                    this.myVideo = null;
                    this.trackList = [];
                    this.room && this.room.disconnect();
                },
                goOut() {
                    this.disconnect();
                    uni.postMessage({
                        data: {
                            isDanger: true
                        }
                    });
                    uni.navigateBack();
                },
                beforeDestroy() {
                    this.room && this.room.disconnect();
                    this.trackList = [];
                },
                // 计时器
                initTimer(func, delay) {
                    let timer = null;
                    const _this = this;
                    const interFunc = function () {
                        if (timer && !_this.isCallIng) {
                            timer = null;
                            clearTimeout(timer);
                            console.log('&&&&&&清空通话中计时器&&&&&&');
                            return;
                        }
                        func.call(null);
                        timer = setTimeout(interFunc, delay); // 递归调用
                    };
                    interFunc();
                },
                // 执行计时器
                timerFn() {
                    this.timeStart = dayjs();
                    const oneHour = 3600;
                    this.initTimer(() => {
                        const secondsDiff = dayjs().diff(this.timeStart, 'second');
                        const format = secondsDiff > oneHour ? 'HH:mm:ss' : 'mm:ss';
                        this.timeText = dayjs.duration(secondsDiff, 'seconds').format(format);
                    }, 1000);
                },
            },
        })
        function uniEvent(res) {
            app.init(res);
        }
    </script>
</body>

</html>